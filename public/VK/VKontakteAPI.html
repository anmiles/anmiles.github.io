<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-type" content="text/html; encoding=utf-8" />
<link rel="stylesheet" href="//vk.com/css/al/common.css?418?304" />
<style type="text/css">
html, body, textarea {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0.5em;
	box-sizing: border-box;
	outline: none;
}
</style>
<script src="//vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
</head>

<body>
<textarea>
/* open your console and press ctrl-enter here to execute all the code */

/* custom part */

(async () => {
	const method = 'wall.search';
	const params = { query: 'anmiles', owners_only: 0 };
	const commentIds = [];

	const callback = async (item) => { 
		if (item.text.toLowerCase().includes(params.query.toLowerCase())) {
			var uid = /[\&\?]viewer_id=(\d+)/.exec(location.search)[1];
			console.warn(item.post_type, `https://vk.com/wall${uid}_${item.id}`);
			console.log(item.text);
		}
	};

	const items = await getAll({ method, params, callback });
	console.log('Total', items.length);
})();

/* required part, not supposed to be changed */

async function getAll({ method, params, callback }) {
	console.log(`Get all by ${method} with ${JSON.stringify(params)}`);
	let response;
	let offset = 0;
	const allItems = [];
	const timeout = 334;

	do {
		await new Promise((resolve) => setTimeout(resolve, timeout));
		response = await get({ method, params, offset });

		for (const item of response.items) {
			callback instanceof Promise ? await callback(item) : callback(item);
		}

		allItems.push(...response.items);
		offset += response.items.length;
	} while (allItems.length < response.count && response.items.length > 0);

	return allItems;
};

async function get({ method, params, offset }) {
	const count = 100;

	return new Promise((resolve, reject) => {
		VK.api(method, { count, ...params, offset }, ({ response, error }) => {
			if (error) {
				console.error(error);
				reject(error);
			}
			else {
				console.log(`Get ${offset + 1}...${Math.min(offset + (params.count || count), response.count)} of ${response.count} (got: ${response.items.length})`);
				resolve(response);
			}
		});
	});
};
</textarea>

<script type="text/javascript">
try {
	VK.init();
} catch (ex) {
	window.clearInterval(window.VKReadyInterval);
	alert('Unable to connect with VK API. Exception: "' + ex.toString() + '"');
}

document.querySelector('textarea').addEventListener('keydown', (ev) => {
	const el = ev.target;

	if ((ev.keyCode == 10 || ev.keyCode == 13) && ev.ctrlKey) {
		eval(el.value);
		return false;
	}

	if (ev.keyCode == 9) {
		ev.preventDefault();
		var start = el.selectionStart;
		var end = el.selectionEnd;
		el.value = el.value.substring(0, start) + '\t' + el.value.substring(end);
		el.selectionStart = el.selectionEnd = start + 1;
		return false;
	}
	
	return true;
});
</script>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-92540327-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-92540327-1');
</script>

</body>
</html>
