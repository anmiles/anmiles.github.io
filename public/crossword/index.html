<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">

<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Crossword</title>
<link href="https://anmiles.net/favicon.ico" type="image/ico" rel="shortcut icon">
<link rel="stylesheet" href="/style.css?v=2023-09-27-00-44-50">
<style type="text/css">
.load {
    position: absolute;
    right: 1em;
    top: 1em;
}

.debug {
    position: absolute;
    right: 1em;
    bottom: 1em;
}

.crossword {
    position: relative;
    line-height: 1em;
}

.crossword [contenteditable] {
    position: absolute;
    background: #ffffff;
    border: 1px solid #252525;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #000000;
    text-transform: uppercase;
    font-size: 0.7em;
    text-align: center;
}

.crossword [contenteditable]:focus {
    background: #ffffcc;
    outline: none;
    border-color: #666600;
}

.crossword i {
    position: absolute;
    z-index: 1;
    pointer-events: none;
    color: #333333;
    font-style: normal;
    font-size: 0.4em;
    line-height: 1;
    padding: 2px;
}

.questions {
    min-height: 4em;
    padding: 1em 0;
}

.history {
    width: 100%;
    height: 6em;
    display: none;
}
</style>
</head>

<body>

<div class="box">
    <div class="crossword">

    </div>
    <div class="questions">

    </div>
    <textarea class="history" readonly></textarea>
</div>

<div class="load">
    <div class="box">
        <a href="#">Load</a>
    </div>
</div>
<div class="debug">
    <div class="box">
        <a href="#">Debug</a>
    </div>
</div>

<script type="text/javascript" src="../externals/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
var cellSize = 30;
var cells = {};
var currentWord = null;
var crosswordHistory = [];

function addCell(word, i) {
    var x = word.direction === 0 ? word.start[0] + i : word.start[0];
    var y = word.direction === 1 ? word.start[1] + i : word.start[1];
    var cell = cells[[x, y]];
    var style = {width: cellSize, height: cellSize, left: x * cellSize, top: y * cellSize};

    if (!cell) {
        cell = $('<div contenteditable></div>').css(style).appendTo('.crossword').get(0);
        cell.position = [x, y];
        cell.words = [];
        cells[[x, y]] = cell;
    }

    cell.words.push(word);

    if (i === 0) $('<i></i>').css(style).text(word.id).appendTo('.crossword');
}

function writeHistory(ev) {
    crosswordHistory.push({event: ev.type, cell: ev.currentTarget.position, value: ev.currentTarget.innerHTML, key: ev.originalEvent.key});
}

function load(json) {
    $('.load').hide();
    var size = [0, 0];

    json.forEach(function(word) {
        size[0] = Math.max(size[0], word.start[0] + word.length * (1 - word.direction));
        size[1] = Math.max(size[1], word.start[1] + word.length * word.direction);

        for (var i = 0; i < word.length; i ++) {
            addCell(word, i);
        }
    });

    $('.crossword').width(size[0] * cellSize).height(size[1] * cellSize).css({'font-size': cellSize + 'px'});

    $('.crossword [contenteditable')
        .on('focus', function(ev) {
            $('.history').hide();
            writeHistory(ev);

            $('.questions').html(this.words.map(function(word) {
                return word.id + '. ' + word.question;
            }).join('<br />'));
        }).on('keydown paste', function(ev) {
            writeHistory(ev);

            if($(this).text().length === 1 && ev.keyCode !== 8) { 
                $(this).text('');
            }
        }).on('keyup', function(ev) {
            writeHistory(ev);
            var cell = this;
            if($(cell).text().length === 0 && ev.keyCode !== 8) return;
            
            if (cell.words.length === 1) {
                currentWord = cell.words[0];
            }
            else {
                var newWord = null;
                var canContinueCurrentWord = false;

                cell.words.forEach(function(word) {
                    if (word === currentWord) canContinueCurrentWord = true;

                    if (word.start[word.direction] + word.length - 1 !== cell.position[word.direction]) {
                        newWord = word;
                    }
                });

                if (newWord != currentWord && !canContinueCurrentWord) {
                    currentWord = newWord;
                }
            }

            newPosition = [cell.position[0], cell.position[1]];
            newPosition[currentWord.direction] += (ev.keyCode === 8 ? -1 : 1);

            if(newPosition[currentWord.direction] >= 0 && newPosition[currentWord.direction] < currentWord.start[currentWord.direction] + currentWord.length) {
                cells[newPosition].innerHTML = '';
                cells[newPosition].focus();
            }
        });
}

$('.load a').click(function(){
    var input = prompt('Insert crossword JSON here');
    var json = null;

    try {
        load(JSON.parse(input));
    } catch {
        alert('Bad JSON');
    }
});

$('.debug a').click(function(){
    var textarea = $('.history');

    if (textarea.is(':visible')) {
        textarea.hide();
    } else {
        textarea.val(JSON.stringify(crosswordHistory)).show().focus();
    }
});

(function(){
    var match = location.search.match(/id=(\d+)/);
    if (!match) return;

    var id = parseInt(match[1]);
    if (isNaN(id)) return;

    $.get('data/' + id + '.json', load);
})();
</script>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-92540327-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-92540327-1');
</script>

</body>

</html>
